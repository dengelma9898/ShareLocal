# ⚠️ WICHTIG: Diese Datei ist nur eine Referenz!
# Die Quelle der Wahrheit ist die NGINX-Konfiguration auf dem Server.
# Diese Datei dient nur als Dokumentation/Referenz.
# 
# Um die aktuelle Konfiguration vom Server zu kopieren:
# scp root@87.106.208.51:/etc/nginx/sites-available/nuernbergspots.conf ./infrastructure/nginx/nuernbergspots.conf
#
# Letzte Aktualisierung: [Bitte Datum eintragen]

server {
    listen 443 ssl http2;
    server_name www.nuernbergspots.de nuernbergspots.de;

    # SSL Zertifikate
    ssl_certificate /etc/ssl/nuernbergspots.de/fullchain.pem;
    ssl_certificate_key /etc/ssl/nuernbergspots.de/privkey.pem;

    # SSL Protokolle und Cipher
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # Session Handling
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_buffer_size 4k;

    # OCSP Stapling
    ssl_stapling on;
    ssl_stapling_verify on;
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 5s;

    # HSTS
    add_header Strict-Transport-Security "max-age=63072000" always;

    # Ihre bestehenden Location-Blöcke und andere Konfigurationen...
    location = /dev/ {
        proxy_pass http://localhost:3000/;
        ...
    }

    # ShareLocal Dev Web - /share-local/dev

    location /share-local/dev {
        proxy_pass http://localhost:3002;
        proxy_http_version 1.1;
    
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Prefix /share-local/dev;
    
        # WebSocket support (für Hot Reload in Dev)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ShareLocal Dev API - /share-local/dev/api
    location /share-local/dev/api {
       rewrite ^/share-local/dev/api/?(.*) /api/$1 break;
       proxy_pass http://localhost:3001;
       proxy_http_version 1.1;
    
       proxy_set_header Host $host;
       proxy_set_header X-Real-IP $remote_addr;
       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
       proxy_set_header X-Forwarded-Proto $scheme;
       proxy_set_header X-Forwarded-Host $host;
    
       # CORS headers
       add_header Access-Control-Allow-Origin * always;
       add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
       add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
    
       if ($request_method = OPTIONS) {
           return 204;
       }
    
       proxy_connect_timeout 60s;
       proxy_send_timeout 60s;
       proxy_read_timeout 60s;
    }

    # ShareLocal Dev Health Check
    location /share-local/dev/health {
       proxy_pass http://localhost:3001/health;
       proxy_http_version 1.1;
       proxy_set_header Host $host;
    }

    # ShareLocal Dev Image Uploads - /share-local/dev/uploads/images/
    # Leitet Requests an die API weiter, die die Bilder selbst serviert (Express.static)
    location /share-local/dev/uploads/images/ {
        rewrite ^/share-local/dev/uploads/images/?(.*) /uploads/images/$1 break;
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    location /prd/ {
        proxy_pass http://localhost:3100/;
        ...
    }

    # ShareLocal Prd Web - /share-local/prd
    location /share-local/prd {
        proxy_pass http://localhost:3102/;
        proxy_http_version 1.1;
    
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Prefix /share-local/prd;
    
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    
        # Caching für statische Assets
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
            proxy_pass http://localhost:3102;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # ShareLocal Prd API - /share-local/prd/api
    location /share-local/prd/api {
        rewrite ^/share-local/prd/api/?(.*) /api/$1 break;
        proxy_pass http://localhost:3101;  # Port 3101 für Production (analog zu anderen Apps: 3100)
        proxy_http_version 1.1;
    
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
    
        # CORS headers
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
    
        if ($request_method = OPTIONS) {
            return 204;
        }
    
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ShareLocal Prd Health Check
    location /share-local/prd/health {
       proxy_pass http://localhost:3101/health;  # Port 3101 für Production
       proxy_http_version 1.1;
       proxy_set_header Host $host;
    }

    # ShareLocal Prd Image Uploads - /share-local/prd/uploads/images/
    # Leitet Requests an die API weiter, die die Bilder selbst serviert (Express.static)
    location /share-local/prd/uploads/images/ {
        rewrite ^/share-local/prd/uploads/images/?(.*) /uploads/images/$1 break;
        proxy_pass http://localhost:3101;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

}